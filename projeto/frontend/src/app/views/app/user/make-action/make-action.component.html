<div class="action-container">
  <div class="container">
    <div class="action-header fade-in">
      <h1 class="page-title">
        @if(userType === 'donor') {
          Registrar Doação
        } @else {
          Fazer Solicitação
        }
      </h1>
      <p class="page-subtitle">
        @if(userType === 'donor') {
          Cadastre os alimentos que você deseja doar
        } @else {
          Solicite os itens que você precisa
        }
      </p>
    </div>

    <div class="action-content">
      @if(userType === 'donor') {
        <div class="action-card card fade-in">
          <div class="card-header">
            <div class="card-icon">
              <mat-icon>volunteer_activism</mat-icon>
            </div>
            <h2>Nova Doação</h2>
          </div>

          <form class="action-form" #donationForm>
            <div class="form-section">
              <h3 class="section-title">Informações do Produto</h3>
              
              <div class="form-row">
                <div class="form-group">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Tipo de Produto</mat-label>
                    <mat-select #productType (selectionChange)="onProductTypeChange(productType.value)">
                      @if (!productType.value) {
                        <mat-option value="">Selecione uma opção</mat-option>
                      }
                      <mat-option value="basic">Alimentos Básicos</mat-option>
                      <mat-option value="hygiene">Produtos de Higiene</mat-option>
                      <mat-option value="infant">Produtos Infantis</mat-option>
                    </mat-select>
                    <mat-icon matPrefix>category</mat-icon>
                  </mat-form-field>
                </div>

                <div class="form-group">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Produto</mat-label>
                    <mat-select #productId required (selectionChange)="onProductChange(productId.value)">
                      @if (!productId.value) {
                        <mat-option value="">Selecione o produto</mat-option>
                      }
                      @for (product of filteredProducts; track product.id) {
                        <mat-option [value]="product.id" [ngClass]="{'low-stock-option': isProductLowStock(product.id!)}">
                          <ng-container>
                            {{ product.name }}
                            @if(isProductLowStock(product.id!)) {
                              <mat-icon class="warning-icon-inline">warning</mat-icon>         
                              <span>(Estoque esgotando)</span>
                            }
                          </ng-container>
                        </mat-option>
                      }
                    </mat-select>
                    <mat-icon matPrefix>inventory</mat-icon>
                  </mat-form-field>
                </div>
              </div>

              <div class="form-row">
                @if (!isToyProduct() && !isNonPerishableProduct()) {
                  <div class="form-group">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Data de Validade</mat-label>
                      <input matInput [matDatepicker]="picker" #expirationDate 
                             placeholder="dd/mm/aaaa" 
                             (input)="formatDate($event)"
                             maxlength="10"
                             required>
                      <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                      <mat-datepicker #picker></mat-datepicker>
                      <mat-icon matPrefix>event</mat-icon>
                    </mat-form-field>
                    @if (isDateInvalid(expirationDate.value)) {
                      <div class="error-message">{{ getDateValidationMessage(expirationDate.value) }}</div>
                    }
                  </div>
                }

                <div class="form-group" [ngClass]="{'centered-quantity': isToyProduct() || isNonPerishableProduct()}">
                  @if (selectedProduct && selectedProduct.measureType !== 'un') {
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Quantidade</mat-label>
                      <mat-select #quantity required (selectionChange)="updateDonationSummary()">
                        @if (!quantity.value) {
                          <mat-option value="">Selecione a quantidade</mat-option>
                        }
                        @if (selectedProduct.optionsDonation && selectedProduct.optionsDonation.length > 0) {
                          @for (option of selectedProduct.optionsDonation; track option) {
                            <mat-option [value]="option">
                              {{ option }} {{ selectedProduct.measureType }}
                            </mat-option>
                          }
                        } @else {
                          <mat-option [value]="1">1 {{ selectedProduct.measureType }}</mat-option>
                        }
                      </mat-select>
                      <mat-icon matPrefix>scale</mat-icon>
                    </mat-form-field>
                  } @else if (selectedProduct && selectedProduct.measureType === 'un') {
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Unidades</mat-label>
                      <input matInput type="number" min="1" step="1" #quantity required (input)="updateDonationSummary()">
                      <mat-icon matPrefix>inventory_2</mat-icon>
                    </mat-form-field>
                  }
                </div>

              </div>

              @if (selectedProduct && selectedProduct.measureType !== 'un') {
                <div class="form-row">
                  <div class="form-group" style="grid-column: 1 / -1; justify-self: center; max-width: 300px;">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Unidades</mat-label>
                      <input matInput type="number" min="1" step="1" #units 
                             (input)="onUnitsInput($event); updateDonationSummary()" required>
                      <mat-icon matPrefix>inventory_2</mat-icon>
                    </mat-form-field>
                  </div>
                </div>
              }

              @if (getDonationSummary()) {
                <div class="donation-summary">
                  <div class="summary-content">
                    <mat-icon>calculate</mat-icon>
                    <span>{{ getDonationSummary() }}</span>
                  </div>
                </div>
              }

              </div>

            <div class="info-message-container">
              <div class="info-message">
                <mat-icon>info</mat-icon>
                <span>Realize a entrega na Unidade de Coleta e Distribuição mais próxima.</span>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" 
                      class="btn btn-primary btn-large" 
                      (click)="onRegisterDonation(productId.value, getExpirationDateValue())">
                <mat-icon>save</mat-icon>
                Registrar Doação
              </button>
              
            </div>
          </form>
        </div>
      }

      @if(userType === 'beneficiary') {
        <div class="action-card card fade-in">
          <div class="card-header">
            <div class="card-icon">
              <mat-icon>request_quote</mat-icon>
            </div>
            <h2>Nova Solicitação</h2>
          </div>

          <form class="action-form">
            <div class="form-section">
              <h3 class="section-title">Tipo de Solicitação</h3>
              
              <div class="form-row">
                <div class="form-group">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Tipo de Cesta</mat-label>
                    <mat-select #basketType>
                      @if (!basketType.value) {
                        <mat-option value="">Selecione uma opção</mat-option>
                      }
                      <mat-option value="basicBasket">Cesta Básica</mat-option>
                      <mat-option value="HygienBasket">Cesta de Higiene</mat-option>
                    </mat-select>
                    <mat-icon matPrefix>shopping_basket</mat-icon>
                  </mat-form-field>
                </div>

                <div class="form-group">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Data da Solicitação</mat-label>
                    <input matInput #requestDate 
                           [value]="getCurrentDateFormatted()"
                           readonly
                           required>
                    <mat-icon matPrefix>event</mat-icon>
                  </mat-form-field>
                </div>
              </div>
            </div>

            <div class="request-status">
              @if (canRequestBasic) {
              <div class="status-item available">
                <mat-icon>check_circle</mat-icon>
                <span>{{ getBasicBasketStatus() }}</span>
              </div>
              } @else {
              <div class="status-item unavailable">
                <mat-icon>schedule</mat-icon>
                <span>{{ getBasicBasketStatus() }}</span>
              </div>
              }
              
              @if (canRequestHygiene) {
              <div class="status-item available">
                <mat-icon>check_circle</mat-icon>
                <span>{{ getHygieneBasketStatus() }}</span>
              </div>
              } @else {
              <div class="status-item unavailable">
                <mat-icon>schedule</mat-icon>
                <span>{{ getHygieneBasketStatus() }}</span>
              </div>
              }
            </div>

            <div class="info-message-container">
              <div class="info-message" style="text-align: center;">
                <mat-icon>info</mat-icon>
                <span style="display: block;">
                  <span style="color: var(--primary-color); font-weight: 600; text-transform: uppercase; display: block; margin-bottom: 8px;">LEMBRE-SE</span>
                  Você pode fazer apenas uma solicitação por mês de cada tipo.<br>
                  Realize a coleta da solicitação na Unidade de Coleta e Distribuição mais próxima.
                </span>
              </div>
            </div>

            <div class="form-actions">
              @if (basketType.value === 'basicBasket') {
              <button type="button" 
                      class="btn btn-outline btn-large"
                      (click)="previewBasket()">
                <mat-icon>preview</mat-icon>
                Ver Prévia da Cesta
              </button>
              }
              
              <button type="button" 
                      class="btn btn-primary btn-large"
                      (click)="basketType.value === 'basicBasket' ? requestBasicBasket() : basketType.value === 'HygienBasket' ? requestHygieneBasket() : null">
                <mat-icon>send</mat-icon>
                Registrar Solicitação
              </button>
              
            </div>
          </form>
        </div>
      }
    </div>
  </div>
</div>

<!-- Modal de Prévia da Cesta -->
@if (showBasketPreview) {
<div class="basket-preview-modal" (click)="closeBasketPreview()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Prévia da Sua Cesta Básica</h3>
      <button class="close-btn" (click)="closeBasketPreview()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="family-info">
  <p><strong>Calculado para:</strong> {{ user?.peopleQuantity }} pessoa(s)</p>
  @if (user?.hasChildren) {
        <p><strong>Inclui itens para crianças:</strong> Sim</p>
        }
      </div>
      
      <div class="basket-items">
        @for (item of calculatedBasket; track item.productId) {
        <div class="item-card">
          <div class="item-info">
            <h4>{{ item.productName }}</h4>
            <p>{{ item.quantity }} {{ item.unitType }}</p>
            <small>{{ item.unitQuantity }} {{ getItemDescription(item.productName) }}</small>
          </div>
        </div>
        }
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeBasketPreview()">
        Fechar
      </button>
      <button class="btn btn-primary" (click)="closeBasketPreview(); requestBasicBasket()">
        Solicitar Esta Cesta
      </button>
    </div>
  </div>
</div>
}